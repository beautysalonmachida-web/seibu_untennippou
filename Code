// ===========================================
// かんたん運転日報システム V4.0
// Google Apps Script バックエンドコード
// ===========================================

const DB_SS_ID = '1V7re633xJUZfVnG1Ym7rvy6nHm1u5nP2HVsN6fL7XOw';
const MASTER_SS_ID = '1Ic4bJeFm8VgQx7WTogNrTiwEUvskw1v0NOTQnD70GGw';

const SHEET_NAMES = {
  LOG_DATA: '運転記録',
  ADMIN_SETTINGS: '管理者設定',
  CAR_LIST: '社用車一覧'
};

const EXT_SHEET_NAMES = {
  EMPLOYEE: '社員マスタ'
};

const STATUS = {
  WORKING: '作業中',
  SAVED: '保存済',
  SUBMITTED: '提出済',
  APPROVED: '承認済',
  REJECTED: '差戻し'
};

function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
    .setTitle('かんたん運転日報 V4.0')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
}

// --- ユーティリティ ---
function getDbSheet(sheetName) {
  try {
    const ss = SpreadsheetApp.openById(DB_SS_ID);
    let sheet = ss.getSheetByName(sheetName);
    if (!sheet && sheetName === SHEET_NAMES.ADMIN_SETTINGS) {
      sheet = ss.insertSheet(SHEET_NAMES.ADMIN_SETTINGS);
      sheet.appendRow(['社員番号', '氏名', '担当拠点']);
    }
    return sheet;
  } catch (e) { throw new Error('DB取得失敗: ' + e.message); }
}

function getMasterSheet(sheetName) {
  try { return SpreadsheetApp.openById(MASTER_SS_ID).getSheetByName(sheetName); } 
  catch (e) { return null; }
}

function generateUUID() { return Utilities.getUuid(); }

function calculateYearMonth(date) {
  const d = new Date(date);
  if (d.getDate() <= 20) return Utilities.formatDate(d, Session.getScriptTimeZone(), 'yyyy-MM');
  const next = new Date(d); next.setMonth(next.getMonth() + 1);
  return Utilities.formatDate(next, Session.getScriptTimeZone(), 'yyyy-MM');
}

function getMonthPeriod(yearMonth) {
  const [year, month] = yearMonth.split('-').map(Number);
  const s = new Date(year, month - 2, 21);
  const e = new Date(year, month - 1, 20);
  return {
    start: Utilities.formatDate(s, Session.getScriptTimeZone(), 'yyyy-MM-dd'),
    end: Utilities.formatDate(e, Session.getScriptTimeZone(), 'yyyy-MM-dd')
  };
}

function getCurrentYearMonth() { return calculateYearMonth(new Date()); }

// --- マスタ取得 ---
function fetchAllEmployees() {
  const sheet = getMasterSheet(EXT_SHEET_NAMES.EMPLOYEE);
  if (!sheet) return {};
  const data = sheet.getDataRange().getValues();
  const employees = {};
  for (let i = 1; i < data.length; i++) {
    const name = String(data[i][0]).trim();
    const id = String(data[i][1]).trim();
    const email = data[i][2] || '';
    const carNumber = String(data[i][3] || '').trim(); // D列: 担当車番
    const base = String(data[i][4] || '').trim();       // E列: 拠点
    if (name && id) employees[name] = { name, userId: id, email, carNumber, base };
  }
  return employees;
}

function fetchAllCars() {
  const sheet = getDbSheet(SHEET_NAMES.CAR_LIST);
  if (!sheet) return [];
  const data = sheet.getDataRange().getValues();
  const cars = [];
  for (let i = 1; i < data.length; i++) {
    const carNumber = String(data[i][0]).trim(); // A列: 車番
    const carType = String(data[i][1] || '').trim(); // B列: 車種
    if (carNumber) {
      cars.push({ carNumber, carType });
    }
  }
  return cars;
}

function fetchAdminSettings() {
  const sheet = getDbSheet(SHEET_NAMES.ADMIN_SETTINGS);
  if (!sheet) return {};
  const data = sheet.getDataRange().getValues();
  const admins = {};
  for (let i = 1; i < data.length; i++) {
    const id = String(data[i][0]).trim();
    const base = String(data[i][2]).trim(); 
    if (id) admins[id] = { base: base };
  }
  return admins;
}

// --- ログイン・認証 ---
function login(userName) {
  try {
    const employees = fetchAllEmployees();
    const user = employees[userName];
    if (!user) return { success: false, message: '社員マスタ未登録' };

    const admins = fetchAdminSettings();
    const adminInfo = admins[user.userId];
    const role = adminInfo ? '管理者' : '使用者';
    const adminBase = adminInfo ? adminInfo.base : '';

    return {
      success: true,
      user: {
        userId: user.userId, name: user.name,
        carNumber: user.carNumber || '',
        base: user.base || '',
        role: role, adminBase: adminBase
      }
    };
  } catch (e) { return { success: false, message: e.message }; }
}

function getUserList() {
  try {
    const emps = fetchAllEmployees();
    const list = Object.values(emps).map(e => ({ userId: e.userId, name: e.name }))
      .sort((a,b) => a.userId.localeCompare(b.userId));
    return { success: true, users: list };
  } catch (e) { return { success: false, message: e.message }; }
}

function getCarList() {
  try {
    const cars = fetchAllCars();
    return { success: true, cars: cars };
  } catch (e) { return { success: false, message: e.message }; }
}

// --- 履歴取得（車両ごとにグループ化 + 車両切替対応） ---
function getHistory(userId, yearMonth, extraCarNumbers = []) {
  try {
    const sheet = getDbSheet(SHEET_NAMES.LOG_DATA);
    if (!sheet) return { success: true, carHistories: [], monthTotal: { distance: 0, workDays: 0 } };

    const data = sheet.getDataRange().getValues();
    const period = getMonthPeriod(yearMonth);
    const startDate = new Date(period.start); startDate.setHours(0,0,0,0);
    const endDate = new Date(period.end); endDate.setHours(23,59,59,999);

    const holidays = {};
    try {
      const cal = CalendarApp.getCalendarById('ja.japanese#holiday@group.v.calendar.google.com');
      cal.getEvents(startDate, endDate).forEach(ev => holidays[Utilities.formatDate(ev.getStartTime(), Session.getScriptTimeZone(), 'yyyy-MM-dd')] = true);
    } catch (err) {}

    // 社員マスタから担当車番を取得
    const allEmployees = fetchAllEmployees();
    let myAssignedCarNum = '';
    Object.values(allEmployees).forEach(emp => {
      if (emp.userId === String(userId) && emp.carNumber) myAssignedCarNum = emp.carNumber;
    });

    const usedCarNumbers = new Set();
    if (myAssignedCarNum) usedCarNumbers.add(myAssignedCarNum);
    if (extraCarNumbers && Array.isArray(extraCarNumbers)) {
      extraCarNumbers.forEach(c => usedCarNumbers.add(c));
    }

    const carRecordsMap = {};
    // 車両ごとの使用日範囲を追跡
    const carDateRange = {};
    let monthStatus = STATUS.WORKING;
    let hasSub = false, hasApp = false, hasRej = false;

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (String(row[2]) !== String(userId)) continue;

      const rowDate = new Date(row[1]);
      if (isNaN(rowDate.getTime())) continue;

      if (rowDate >= startDate && rowDate <= endDate) {
        const dateStr = Utilities.formatDate(rowDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
        const carNum = String(row[4] || '未設定');

        usedCarNumbers.add(carNum);

        if (!carRecordsMap[carNum]) carRecordsMap[carNum] = {};
        if (!carDateRange[carNum]) carDateRange[carNum] = { first: dateStr, last: dateStr };
        if (dateStr < carDateRange[carNum].first) carDateRange[carNum].first = dateStr;
        if (dateStr > carDateRange[carNum].last) carDateRange[carNum].last = dateStr;

        const st = String(row[18] || '作業中');
        if (st === STATUS.APPROVED) hasApp = true;
        if (st === STATUS.SUBMITTED) hasSub = true;
        if (st === STATUS.REJECTED) hasRej = true;

        carRecordsMap[carNum][dateStr] = {
          id: String(row[0]),
          date: dateStr,
          carNumber: carNum,
          departureMeter: String(row[5] || ''),
          arrivalMeter: String(row[6] || ''),
          distance: String(row[7] || ''),
          destination: String(row[8] || ''),
          alcoholStart: String(row[9] || ''),
          alcoholEnd: String(row[11] || ''),
          dailyCheck: String(row[10] || ''),
          carCleaning: String(row[12] || ''),
          troubleStatus: String(row[13] || ''),
          troubleDetail: String(row[14] || ''),
          refuel: String(row[15] || ''),
          remarks: String(row[16] || ''),
          status: st,
          rejectComment: String(row[22] || ''),
          isSaved: true
        };
      }
    }

    if (hasApp) monthStatus = STATUS.APPROVED;
    else if (hasSub) monthStatus = STATUS.SUBMITTED;
    else if (hasRej) monthStatus = STATUS.REJECTED;

    const carHistories = [];
    let monthTotalDist = 0;
    let monthTotalDays = 0;

    usedCarNumbers.forEach(carNum => {
      const dailyList = [];
      let carDist = 0;
      let carDays = 0;
      const currentDate = new Date(startDate);

      // 担当車番 or 手動追加車両 → 全日付表示
      // レコードから検出された車両 → 使用期間のみ表示
      const isAssignedOrExtra = (carNum === myAssignedCarNum) ||
        (extraCarNumbers && extraCarNumbers.includes(carNum));
      const range = carDateRange[carNum];

      while (currentDate <= endDate) {
        const dateStr = Utilities.formatDate(currentDate, Session.getScriptTimeZone(), 'yyyy-MM-dd');
        const dayOfWeek = currentDate.getDay();
        const isHoliday = !!holidays[dateStr];

        const record = (carRecordsMap[carNum] && carRecordsMap[carNum][dateStr]) ? carRecordsMap[carNum][dateStr] : null;

        // この日付を表示するかどうか判定
        let showDate = false;
        if (isAssignedOrExtra) {
          showDate = true; // 担当車・追加車両は全日表示
        } else if (range) {
          showDate = (dateStr >= range.first && dateStr <= range.last); // レコード範囲内のみ
        }

        if (showDate) {
          if (record) {
            dailyList.push({ ...record, dayOfWeek, isHoliday });
            const d = parseFloat(record.distance);
            if (!isNaN(d) && d > 0) { carDist += d; carDays++; }
          } else {
            dailyList.push({
              id: '', date: dateStr, carNumber: carNum,
              departureMeter: '', arrivalMeter: '', distance: '', destination: '',
              alcoholStart: '', alcoholEnd: '', dailyCheck: '', carCleaning: '', troubleStatus: '',
              refuel: '', remarks: '', status: '', rejectComment: '', isSaved: false,
              dayOfWeek, isHoliday
            });
          }
        }
        currentDate.setDate(currentDate.getDate() + 1);
      }

      if (dailyList.length > 0) {
        carHistories.push({
          carNumber: carNum,
          records: dailyList,
          subtotal: { distance: Math.round(carDist * 10) / 10, workDays: carDays }
        });
        monthTotalDist += carDist;
        monthTotalDays += carDays;
      }
    });

    return {
      success: true,
      carHistories: carHistories,
      monthStatus: monthStatus,
      monthTotal: { distance: Math.round(monthTotalDist * 10) / 10, workDays: monthTotalDays }
    };
  } catch (e) {
    return { success: false, message: '履歴取得エラー: ' + e.message };
  }
}

function getMonthlyDistance(userId, yearMonth) {
  const r = getHistory(userId, yearMonth);
  if (!r.success) return r;
  let dist=0, days=0;
  
  r.carHistories.forEach(hist => {
      hist.records.forEach(re => {
        if(re.isSaved){
          const d = parseFloat(re.distance);
          if(!isNaN(d) && d>0){ dist+=d; days++; }
        }
      });
  });
  
  return {success:true, totalDistance:Math.round(dist*10)/10, workDays:days, status:r.monthStatus};
}

// --- メーター補完ロジック ---
function findPreviousArrival(carNumber, targetDateStr, sheetData) {
  let maxMeter = 0;
  const targetDate = new Date(targetDateStr);
  for (let i = 1; i < sheetData.length; i++) {
    const row = sheetData[i];
    if (String(row[4]) === String(carNumber)) { 
      const rowDate = new Date(row[1]);
      if (rowDate < targetDate) { 
        const m = parseFloat(row[6]); 
        if (!isNaN(m)) {
          if (m > maxMeter) maxMeter = m;
        }
      }
    }
  }
  return maxMeter;
}

// --- 保存処理 ---
function saveHistoryBulk(userId, userName, updates) {
  const lock = LockService.getScriptLock();
  if(!lock.tryLock(10000)) return {success:false, message:'他ユーザー編集中'};
  try {
    const sheet = getDbSheet(SHEET_NAMES.LOG_DATA);
    const data = sheet.getDataRange().getValues();
    const now = new Date();
    const idMap = {};
    for(let i=1; i<data.length; i++) idMap[String(data[i][0])] = i+1;
    
    updates.forEach(rec=>{
      let rIdx = -1;
      if(rec.id && idMap[rec.id]){
        rIdx = idMap[rec.id];
        const stat = data[rIdx-1][18];
        if(stat===STATUS.SUBMITTED || stat===STATUS.APPROVED) return;
      } else if(!rec.id && !rec.destination && !rec.arrivalMeter) return;

      const dStr = rec.date;
      const ym = calculateYearMonth(new Date(dStr));
      const arr = parseFloat(rec.arrivalMeter)||0;
      
      let dep = 0;
      if (rec.departureMeter !== undefined && rec.departureMeter !== '') {
          dep = parseFloat(rec.departureMeter);
      } else if (rIdx > 0) {
          dep = parseFloat(data[rIdx-1][5]) || 0; 
      }
      if (dep === 0 && arr > 0 && rec.carNumber) {
          dep = findPreviousArrival(rec.carNumber, dStr, data);
      }
      
      let dist = '';
      if (arr > 0) {
          dist = (arr > dep) ? (arr - dep) : 0;
      } else if (rec.distance) {
          dist = parseFloat(rec.distance);
      }

      const vals = {
          date: dStr, userId: userId, userName: userName, carNumber: rec.carNumber,
          dep: dep, arr, dist, dest: rec.destination,
          alcStart: rec.alcoholStart||'未', daily: rec.dailyCheck||'異常なし', 
          alcEnd: rec.alcoholEnd||'未', clean: rec.carCleaning||'未',
          trouble: rec.troubleStatus||'なし', detail: rec.troubleDetail||'',
          refuel: rec.refuel, rem: rec.remarks, ym: ym, now: now
      };

      if(rIdx>0){
        const r = rIdx;
        sheet.getRange(r,2).setValue(vals.date);
        sheet.getRange(r,5).setValue(vals.carNumber);
        sheet.getRange(r,6).setValue(vals.dep);
        sheet.getRange(r,7).setValue(vals.arr);
        sheet.getRange(r,8).setValue(vals.dist);
        sheet.getRange(r,9).setValue(vals.dest);
        sheet.getRange(r,10).setValue(vals.alcStart);
        sheet.getRange(r,11).setValue(vals.daily);
        sheet.getRange(r,12).setValue(vals.alcEnd);
        sheet.getRange(r,13).setValue(vals.clean);
        sheet.getRange(r,14).setValue(vals.trouble);
        sheet.getRange(r,15).setValue(vals.detail);
        sheet.getRange(r,16).setValue(vals.refuel);
        sheet.getRange(r,17).setValue(vals.rem);
        sheet.getRange(r,19).setValue(STATUS.SAVED);
        sheet.getRange(r,22).setValue(vals.now);
      } else {
        const uuid = generateUUID();
        const row = [
            uuid, vals.date, vals.userId, vals.userName, vals.carNumber, 
            vals.dep, vals.arr, vals.dist, vals.dest, 
            vals.alcStart, vals.daily, vals.alcEnd, vals.clean, 
            vals.trouble, vals.detail, vals.refuel, vals.rem, 
            vals.ym, STATUS.SAVED, '', '', vals.now, ''
        ];
        sheet.appendRow(row);
      }
    });
    return {success:true, message:'一括保存しました'};
  } catch(e){ return {success:false, message:e.message}; } finally { lock.releaseLock(); }
}

function saveArrival(data) {
  const lock = LockService.getScriptLock();
  try{
    lock.waitLock(10000);
    const sheet = getDbSheet(SHEET_NAMES.LOG_DATA);
    const now = new Date();
    const sData = sheet.getDataRange().getValues();
    
    let dep = parseFloat(data.departureMeter)||0;
    const arr = parseFloat(data.arrivalMeter)||0;
    
    if (dep === 0 && arr > 0) {
        dep = findPreviousArrival(data.carNumber, data.date, sData);
    }
    
    const dist = (arr > dep) ? (arr - dep) : 0;
    
    let rIdx = -1;
    if(data.id){
      for(let i=1; i<sData.length; i++){
        if(String(sData[i][0])===String(data.id)){ rIdx=i+1; break; }
      }
    }
    const ym = calculateYearMonth(new Date(data.date));
    if(rIdx>0){
      const st = sData[rIdx-1][18];
      if(st===STATUS.SUBMITTED || st===STATUS.APPROVED) return {success:false, message:'提出済のため編集不可'};
      const r = rIdx;
      const vals = [
          [data.date, data.userId, data.userName, data.carNumber, dep, arr, dist, data.destination,
           data.alcoholCheckStart, data.dailyCheck, data.alcoholCheckEnd, data.carCleaning,
           data.troubleStatus, data.troubleDetail, data.refuel, data.remarks, ym, STATUS.SAVED, '', '', now, '']
      ];
      sheet.getRange(r, 2, 1, 22).setValues(vals);
    } else {
      const uuid = generateUUID();
      sheet.appendRow([uuid, data.date, data.userId, data.userName, data.carNumber, dep, arr, dist, data.destination, data.alcoholCheckStart, data.dailyCheck, data.alcoholCheckEnd, data.carCleaning, data.troubleStatus, data.troubleDetail, data.refuel, data.remarks, ym, STATUS.SAVED, '', '', now, '']);
    }
    return {success:true, message:'保存しました'};
  } catch(e){ return {success:false, message:e.message}; } finally { lock.releaseLock(); }
}

function submitMonthly(userId, yearMonth) {
  const lock = LockService.getScriptLock();
  try{
    lock.waitLock(10000);
    const sheet = getDbSheet(SHEET_NAMES.LOG_DATA);
    const data = sheet.getDataRange().getValues();
    const period = getMonthPeriod(yearMonth);
    const s = new Date(period.start); s.setHours(0,0,0,0);
    const e = new Date(period.end); e.setHours(23,59,59,999);
    let c = 0;
    for(let i=1; i<data.length; i++){
      const d = new Date(data[i][1]);
      if(String(data[i][2])===String(userId) && d>=s && d<=e && (data[i][18]===STATUS.SAVED || data[i][18]===STATUS.WORKING || data[i][18]===STATUS.REJECTED)){
        sheet.getRange(i+1, 19).setValue(STATUS.SUBMITTED);
        c++;
      }
    }
    return {success:true, message:c+'件 提出しました'};
  } finally { lock.releaseLock(); }
}

function testGetCurrentYearMonth() {
  const ym = getCurrentYearMonth();
  const p = getMonthPeriod(ym);
  return {yearMonth:ym, period:p};
}

function getLastMeter(carNumber) {
  try {
    const sheet = getDbSheet(SHEET_NAMES.LOG_DATA);
    if(!sheet) return {success:true, lastMeter:0};
    const data = sheet.getDataRange().getValues();
    let max = 0;
    for(let i=1; i<data.length; i++){
      if(String(data[i][4])===String(carNumber)){
        const m = parseFloat(data[i][6]); 
        if(!isNaN(m) && m>max) max=m;
      }
    }
    return {success:true, lastMeter:max};
  } catch(e){ return {success:false, lastMeter:0}; }
}

// --- 管理者機能系 ---

// 未承認リスト
function getAdminPendingList(adminUserId) {
  try {
    const admins = fetchAdminSettings();
    const adminInfo = admins[adminUserId];
    if (!adminInfo) return { success: false, message: '管理者権限なし' };
    const targetBase = adminInfo.base;

    // 社員マスタから拠点マッピング取得
    const allEmployees = fetchAllEmployees();
    const userBaseMap = {};
    Object.values(allEmployees).forEach(emp => {
      userBaseMap[emp.userId] = emp.base || '不明';
    });

    const sheet = getDbSheet(SHEET_NAMES.LOG_DATA);
    const data = sheet.getDataRange().getValues();
    const grouped = {};

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const status = String(row[18]);
      if (status === STATUS.SUBMITTED || status === STATUS.APPROVED) {
        const userId = String(row[2]);
        const recordBase = userBaseMap[userId] || '不明';

        if (targetBase && recordBase !== '不明' && targetBase !== recordBase) continue;

        let ym = row[17];
        const userName = String(row[3]);
        const key = userId + '_' + ym;

        if (!grouped[key]) {
          grouped[key] = { userId, userName, yearMonth: ym, status, totalDistance: 0, workDays: 0, base: recordBase };
        }
        if (status === STATUS.APPROVED) grouped[key].status = STATUS.APPROVED;

        const dist = parseFloat(row[7]);
        if (!isNaN(dist) && dist > 0) {
          grouped[key].totalDistance += dist;
          grouped[key].workDays++;
        }
      }
    }
    let list = Object.values(grouped);
    list.sort((a, b) => (a.status === STATUS.SUBMITTED && b.status !== STATUS.SUBMITTED) ? -1 : 1);
    return { success: true, list };
  } catch (e) { return { success: false, message: e.message }; }
}

// 提出状況マトリクス取得
function getSubmissionMatrix(adminUserId) {
  try {
    const admins = fetchAdminSettings();
    const adminInfo = admins[adminUserId];
    if (!adminInfo) return { success: false, message: '管理者権限なし' };
    const targetBase = adminInfo.base;

    const allEmployees = fetchAllEmployees();

    const employees = [];
    Object.values(allEmployees).forEach(emp => {
      const base = emp.base || '不明';
      if (targetBase && base !== targetBase && base !== '不明') return;
      employees.push({ userId: emp.userId, name: emp.name, base });
    });

    employees.sort((a, b) => a.userId.localeCompare(b.userId));

    // 表示年月リスト作成（直近6ヶ月）
    const months = [];
    const today = new Date();
    let currentYM = calculateYearMonth(today);
    let y = parseInt(currentYM.split('-')[0]);
    let m = parseInt(currentYM.split('-')[1]);
    
    for(let i=0; i<6; i++) {
        months.push(`${y}-${String(m).padStart(2,'0')}`);
        m--;
        if(m===0) { m=12; y--; }
    }
    months.reverse();

    const sheet = getDbSheet(SHEET_NAMES.LOG_DATA);
    const data = sheet.getDataRange().getValues();
    
    const statusMap = {};
    
    for(let i=1; i<data.length; i++) {
      const row = data[i];
      const uid = String(row[2]);
      const ym = String(row[17]); 
      const st = String(row[18]); 
      
      const key = `${uid}_${ym}`;
      
      const current = statusMap[key];
      if(st === STATUS.APPROVED) statusMap[key] = STATUS.APPROVED;
      else if(st === STATUS.SUBMITTED && current !== STATUS.APPROVED) statusMap[key] = STATUS.SUBMITTED;
      else if(st === STATUS.REJECTED && current !== STATUS.APPROVED && current !== STATUS.SUBMITTED) statusMap[key] = STATUS.REJECTED;
      else if((st === STATUS.WORKING || st === STATUS.SAVED) && !current) statusMap[key] = '未提出';
    }

    const matrix = employees.map(emp => {
      const rowData = {
        userId: emp.userId,
        name: emp.name,
        base: emp.base,
        statuses: {}
      };
      months.forEach(ym => {
        const key = `${emp.userId}_${ym}`;
        rowData.statuses[ym] = statusMap[key] || '-';
      });
      return rowData;
    });

    return { success: true, months: months, matrix: matrix, adminBase: targetBase || '全拠点' };
    
  } catch (e) { return { success: false, message: e.message }; }
}

function approveMonthly(adminId, adminName, targetUserId, yearMonth) {
  const lock = LockService.getScriptLock();
  if(!lock.tryLock(10000)) return {success:false,message:'Busy'};
  try {
    const sheet = getDbSheet(SHEET_NAMES.LOG_DATA);
    const data = sheet.getDataRange().getValues();
    const period = getMonthPeriod(yearMonth);
    const s = new Date(period.start); s.setHours(0,0,0,0);
    const e = new Date(period.end); e.setHours(23,59,59,999);
    const now = new Date();
    let c = 0;
    for(let i=1; i<data.length; i++){
      const d = new Date(data[i][1]);
      if(String(data[i][2])===String(targetUserId) && d>=s && d<=e && String(data[i][18])===STATUS.SUBMITTED){
        sheet.getRange(i+1, 19).setValue(STATUS.APPROVED);
        sheet.getRange(i+1, 20).setValue(adminName);
        sheet.getRange(i+1, 21).setValue(now);
        c++;
      }
    }
    return {success:true, message:c+'件 承認'};
  } finally { lock.releaseLock(); }
}

function rejectMonthly(adminId, targetUserId, yearMonth, comment) {
  const lock = LockService.getScriptLock();
  if(!lock.tryLock(10000)) return {success:false,message:'Busy'};
  try {
    const sheet = getDbSheet(SHEET_NAMES.LOG_DATA);
    const data = sheet.getDataRange().getValues();
    const period = getMonthPeriod(yearMonth);
    const s = new Date(period.start); s.setHours(0,0,0,0);
    const e = new Date(period.end); e.setHours(23,59,59,999);
    let c = 0;
    for(let i=1; i<data.length; i++){
      const d = new Date(data[i][1]);
      const st = String(data[i][18]);
      if(String(data[i][2])===String(targetUserId) && d>=s && d<=e && (st===STATUS.SUBMITTED||st===STATUS.APPROVED)){
        sheet.getRange(i+1, 19).setValue(STATUS.REJECTED);
        sheet.getRange(i+1, 23).setValue(comment);
        sheet.getRange(i+1, 20).clearContent();
        sheet.getRange(i+1, 21).clearContent();
        c++;
      }
    }
    return {success:true, message:c+'件 差戻し'};
  } finally { lock.releaseLock(); }
}
